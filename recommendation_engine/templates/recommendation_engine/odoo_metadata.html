{% load static %}  
<!DOCTYPE html>  
<html lang="fr">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Gouvernance des Données Odoo - Vue Consolidée</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
    <link rel="stylesheet" href="{% static 'recommendation_engine/toast.css' %}">  
    <style>  
        @keyframes pulse-slow {  
            0%, 100% { opacity: 1; }  
            50% { opacity: 0.5; }  
        }  
        .animate-pulse-slow {  
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;  
        }  
    </style>  
</head>  
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">  
      
    <!-- Navigation -->  
    <nav class="bg-white shadow-lg fixed top-0 left-0 right-0 z-50">  
        {% include 'csv_anonymizer/datasteward_navigation.html' %}  
    </nav>  
  
    <div class="container mx-auto px-4 py-8 mt-20">  
          
        <!-- Header Principal -->  
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8">  
            <div class="flex items-center justify-between mb-6">  
                <div class="flex items-center space-x-4">  
                    <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 rounded-xl shadow-lg">  
                        <i class="fas fa-shopping-cart text-white text-3xl"></i>  
                    </div>  
                    <div>  
                        <h1 class="text-4xl font-bold text-gray-800">  
                            Gouvernance des Données Odoo  
                        </h1>  
                        <p class="text-gray-600 mt-2 text-lg">  
                            Analyse consolidée par Semantic Analyzer • {{ total_jobs }} batches Kafka traités  
                        </p>  
                    </div>  
                </div>  
                <div class="flex items-center space-x-2 bg-green-100 px-4 py-2 rounded-lg">  
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse-slow"></div>  
                    <span class="text-green-800 font-semibold">Kafka Actif</span>  
                </div>  
            </div>  
  
            <!-- Stats Cards -->  
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">  
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border-l-4 border-blue-500">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-sm text-blue-600 font-medium">Colonnes Analysées</p>  
                            <p class="text-2xl font-bold text-blue-900">{{ stats.total_columns }}</p>  
                        </div>  
                        <i class="fas fa-database text-blue-500 text-3xl opacity-50"></i>  
                    </div>  
                </div>  
  
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border-l-4 border-purple-500">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-sm text-purple-600 font-medium">Records Totaux</p>  
                            <p class="text-2xl font-bold text-purple-900">{{ stats.total_records }}</p>  
                        </div>  
                        <i class="fas fa-chart-line text-purple-500 text-3xl opacity-50"></i>  
                    </div>  
                </div>  
  
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border-l-4 border-green-500">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-sm text-green-600 font-medium">Validées</p>  
                            <p class="text-2xl font-bold text-green-900">{{ stats.validated }}</p>  
                        </div>  
                        <i class="fas fa-check-circle text-green-500 text-3xl opacity-50"></i>  
                    </div>  
                </div>  
  
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-4 border-l-4 border-yellow-500">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-sm text-yellow-600 font-medium">En Attente</p>  
                            <p class="text-2xl font-bold text-yellow-900">{{ stats.pending }}</p>  
                        </div>  
                        <i class="fas fa-clock text-yellow-500 text-3xl opacity-50"></i>  
                    </div>  
                </div>  
  
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 border-l-4 border-red-500">  
                    <div class="flex items-center justify-between">  
                        <div>  
                            <p class="text-sm text-red-600 font-medium">Rejetées</p>  
                            <p class="text-2xl font-bold text-red-900">{{ stats.rejected }}</p>  
                        </div>  
                        <i class="fas fa-times-circle text-red-500 text-3xl opacity-50"></i>  
                    </div>  
                </div>  
            </div>  
        </div>  
  
        <!-- Filters -->  
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">  
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">  
                <div class="flex-1 w-full relative">  
                    <i class="fas fa-search text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>  
                    <input  
                        type="text"  
                        id="searchInput"  
                        placeholder="Rechercher une colonne..."  
                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"  
                        onkeyup="filterTable()"  
                    />  
                </div>  
                <div class="flex items-center space-x-2">  
                    <i class="fas fa-filter text-gray-500"></i>  
                    <select  
                        id="statusFilter"  
                        class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"  
                        onchange="filterTable()"  
                    >  
                        <option value="all">Tous les statuts</option>  
                        <option value="validated">Validées</option>  
                        <option value="pending">En attente</option>  
                        <option value="rejected">Rejetées</option>  
                    </select>  
                </div>  
            </div>  
        </div>  
  
        <!-- Consolidated Table -->  
        <div class="bg-white rounded-xl shadow-xl overflow-hidden">  
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">  
                <h2 class="text-xl font-bold text-white flex items-center">  
                    <i class="fas fa-chart-bar mr-3"></i>  
                    Vue Consolidée des Métadonnées (Tous les Batches)  
                </h2>  
            </div>  
  
            <div class="overflow-x-auto">  
                <table class="w-full" id="metadataTable">  
                    <thead class="bg-gray-50">  
                        <tr>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Colonne</th>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Type d'Entité</th>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Records Analysés</th>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Statut</th>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Catégorie RGPD</th>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Sensibilité</th>  
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>  
                        </tr>  
                    </thead>  
                    <tbody class="divide-y divide-gray-200">  
                        {% for column in consolidated_metadata %}  
                        <tr class="hover:bg-purple-50 transition-colors" data-status="{{ column.validation_status }}" data-column="{{ column.column_name|lower }}">  
                            <td class="px-6 py-4">  
                                <div class="flex items-center">  
                                    <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>  
                                    <span class="font-semibold text-gray-900">{{ column.column_name }}</span>  
                                </div>  
                            </td>  
                            <td class="px-6 py-4">  
                                {% for entity_type in column.entity_types %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-1 mb-1">  
                                    {{ entity_type }}  
                                </span>  
                                {% endfor %}  
                            </td>  
                            <td class="px-6 py-4">  
                                <div class="text-sm">  
                                    <p class="font-semibold text-gray-900">{{ column.total_records }}</p>  
                                    <p class="text-gray-500">sur {{ column.total_jobs }} batches</p>  
                                </div>  
                            </td>  
                            <td class="px-6 py-4">  
                                {% if column.validation_status == 'validated' %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">  
                                    <i class="fas fa-check-circle mr-1"></i> Validé  
                                </span>  
                                {% elif column.validation_status == 'pending' %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">  
                                    <i class="fas fa-clock mr-1"></i> En attente  
                                </span>  
                                {% elif column.validation_status == 'rejected' %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">  
                                    <i class="fas fa-times-circle mr-1"></i> Rejeté  
                                </span>  
                                {% endif %}  
                            </td>  
                            <td class="px-6 py-4">  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">  
                                    {{ column.recommended_rgpd_category }}  
                                </span>  
                            </td>  
                            <td class="px-6 py-4">  
                                {% if column.recommended_sensitivity_level == 'PERSONAL_DATA' %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">  
                                    <i class="fas fa-shield-alt mr-1"></i> {{ column.recommended_sensitivity_level }}  
                                </span>  
                                {% elif column.recommended_sensitivity_level == 'CONFIDENTIAL' %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800">  
                                    <i class="fas fa-shield-alt mr-1"></i> {{ column.recommended_sensitivity_level }}  
                                </span>  
                                {% else %}  
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">  
                                    <i class="fas fa-shield-alt mr-1"></i> {{ column.recommended_sensitivity_level }}  
                                </span>  
                                {% endif %}  
                            </td>  
                            
                            <td class="px-6 py-4">  
                                <button onclick="openValidationModal('{{ column.column_name|escapejs }}', {{ column.entity_types|safe }})"  
                                        class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2 dark:bg-gray-800 dark:hover:bg-gray-700 dark:focus:ring-gray-700 dark:border-gray-700">  
                                    <i class="fas fa-check-circle mr-2"></i>  
                                    Valider  
                                </button>  
                            </td>  
                        </tr>  
                        {% empty %}  
                        <tr>  
                            <td colspan="8" class="px-6 py-12 text-center">  
                                <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>  
                                <p class="text-gray-500 text-lg">Aucune métadonnée consolidée disponible</p>  
                            </td>  
                        </tr>  
                        {% endfor %}  
                    </tbody>  
                </table>  
            </div>  
        </div>  
  
        <!-- Info Banner -->  
      
    </div>  
  
    <!-- Modal de Validation -->  
    <div id="validationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">  
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">  
            <div class="flex justify-between items-center mb-4">  
                <h3 class="text-2xl font-bold text-gray-900">Validation de Colonne Consolidée</h3>  
                <button onclick="closeValidationModal()" class="text-gray-400 hover:text-gray-600">  
                    <i class="fas fa-times text-2xl"></i>  
                </button>  
            </div>  
              
            <form id="validationForm" class="space-y-4">  
                <input type="hidden" id="modalColumnName" name="column_name">  
                  
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">  
                    <p class="text-sm text-purple-800">  
                        <i class="fas fa-info-circle mr-2"></i>  
                        Cette validation s'appliquera à tous les batches contenant cette colonne  
                    </p>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type d'Entité</label>  
                    <select id="entityType" name="entity_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">  
                        <option value="PERSON">PERSON</option>  
                        <option value="EMAIL_ADDRESS">EMAIL_ADDRESS</option>  
                        <option value="PHONE_NUMBER">PHONE_NUMBER</option>  
                        <option value="LOCATION">LOCATION</option>  
                        <option value="ORGANIZATION">ORGANIZATION</option>  
                        <option value="ID_MAROC">ID_MAROC</option>  
                        <option value="IBAN_CODE">IBAN_CODE</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Statut de Validation</label>  
                    <select id="validationStatus" name="validation_status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">  
                        <option value="validated">✅ Validé</option>  
                        <option value="rejected">❌ Rejeté</option>  
                        <option value="pending">⏳ En attente</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie RGPD</label>  
                    <select id="rgpdCategory" name="rgpd_category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">  
                        <option value="Données d'identification">Données d'identification</option>  
                        <option value="Données de contact">Données de contact</option>  
                        <option value="Données de localisation">Données de localisation</option>  
                        <option value="Données financières">Données financières</option>  
                        <option value="Données comportementales">Données comportementales</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Niveau de Sensibilité</label>  
                    <select id="sensitivityLevel" name="sensitivity_level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">  
                        <option value="PERSONAL_DATA">PERSONAL_DATA</option>  
                        <option value="CONFIDENTIAL">CONFIDENTIAL</option>  
                        <option value="INTERNAL">INTERNAL</option>  
                        <option value="PUBLIC">PUBLIC</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Politique Ranger</label>  
                    <select id="rangerPolicy" name="ranger_policy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">  
                        <option value="ranger_masking_policy_person">Masquage Complet</option>  
                        <option value="ranger_partial_masking_policy_phone">Masquage Partiel (Téléphone)</option>  
                        <option value="ranger_partial_masking_policy_email">Masquage Partiel (Email)</option>  
                        <option value="ranger_hashing_policy_id">Hachage</option>  
                        <option value="ranger_encryption_policy_financial">Chiffrement</option>  
                        <option value="ranger_generalization_policy_location">Généralisation</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Commentaires</label>  
                    <textarea id="comments" name="comments" rows="3"   
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500"  
                              placeholder="Ajoutez des notes sur cette validation..."></textarea>  
                </div>  
                  
                <div class="flex justify-end space-x-3 pt-4">  
                    <button type="button" onclick="closeValidationModal()"   
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">  
                        Annuler  
                    </button>  
                    <button type="button" onclick="saveValidation()"   
                            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-md hover:from-purple-700 hover:to-pink-700 transition-all shadow-md">  
                        <i class="fas fa-save mr-2"></i>Sauvegarder  
                    </button>  
                </div>  
            </form>  
        </div>  
    </div>  
  
    <script>  
        // Obtenir le CSRF token  
        function getCookie(name) {  
            let cookieValue = null;  
            if (document.cookie && document.cookie !== '') {  
                const cookies = document.cookie.split(';');  
                for (let i = 0; i < cookies.length; i++) {  
                    const cookie = cookies[i].trim();  
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {  
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));  
                        break;  
                    }  
                }  
            }  
            return cookieValue;  
        }  
          
        const csrftoken = getCookie('csrftoken');  
          
        // Fonction de filtrage du tableau  
        function filterTable() {  
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();  
            const statusFilter = document.getElementById('statusFilter').value;  
            const rows = document.querySelectorAll('#metadataTable tbody tr');  
              
            rows.forEach(row => {  
                const columnName = row.getAttribute('data-column');  
                const status = row.getAttribute('data-status');  
                  
                const matchesSearch = !columnName || columnName.includes(searchTerm);  
                const matchesStatus = statusFilter === 'all' || status === statusFilter;  
                  
                if (matchesSearch && matchesStatus) {  
                    row.style.display = '';  
                } else {  
                    row.style.display = 'none';  
                }  
            });  
        }  
          
        // Ouvrir le modal de validation  
        function openValidationModal(columnName, entityTypes) {  
            document.getElementById('modalColumnName').value = columnName;  
              
            if (entityTypes && entityTypes.length > 0) {  
                document.getElementById('entityType').value = entityTypes[0];  
            }  
              
            document.getElementById('validationModal').classList.remove('hidden');  
        }  
          
        // Fermer le modal  
        function closeValidationModal() {  
            document.getElementById('validationModal').classList.add('hidden');  
        }  
          
        // Sauvegarder la validation  
        function saveValidation() {  
            const columnName = document.getElementById('modalColumnName').value;  
              
            const data = {  
                entity_type: document.getElementById('entityType').value,  
                validation_status: document.getElementById('validationStatus').value,  
                rgpd_category: document.getElementById('rgpdCategory').value,  
                sensitivity_level: document.getElementById('sensitivityLevel').value,  
                ranger_policy: document.getElementById('rangerPolicy').value,  
                comments: document.getElementById('comments').value  
            };  
              
            // Envoyer la validation pour TOUTES les colonnes avec ce nom  
            fetch(`/recommendations/column-validation-consolidated/${columnName}/`, {  
                method: 'POST',  
                headers: {  
                    'Content-Type': 'application/json',  
                    'X-CSRFToken': csrftoken  
                },  
                body: JSON.stringify(data)  
            })  
            .then(response => response.json())  
            .then(result => {  
                if (result.success) {  
                    showToast('✅ Validation sauvegardée pour tous les batches', 'success');  
                    closeValidationModal();  
                    setTimeout(() => location.reload(), 1500);  
                } else {  
                    showToast('❌ Erreur: ' + result.error, 'error');  
                }  
            })  
            .catch(error => {  
                showToast('❌ Erreur réseau', 'error');  
                console.error('Error:', error);  
            });  
        }  
          
        // Afficher un toast  
        function showToast(message, type) {  
            const toast = document.createElement('div');  
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} z-50 animate-fade-in`;  
            toast.textContent = message;  
            document.body.appendChild(toast);  
            setTimeout(() => toast.remove(), 3000);  
        }  
          
        // Fermer le modal en cliquant à l'extérieur  
        window.onclick = function(event) {  
            const modal = document.getElementById('validationModal');  
            if (event.target === modal) {  
                closeValidationModal();  
            }  
        }  
    </script>  
</body>  
</html>