{% load static %}  
<!DOCTYPE html>  
<html lang="fr">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">  
    <meta http-equiv="Pragma" content="no-cache">  
    <meta http-equiv="Expires" content="0">
    <title>Métadonnées Odoo - Sale Orders</title>   
    <link rel="stylesheet" href="{% static 'recommendation_engine/toast.css' %}">  
    <script src="https://cdn.tailwindcss.com"></script>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
</head>  
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">  
    <nav class="bg-white shadow">  
        {% include 'csv_anonymizer/datasteward_navigation.html' %}  
    </nav>  
      
    <div class="container mx-auto px-4 py-8 mt-20">  
        <!-- Header -->  
        <div class="text-center mb-12">  
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full mb-4">  
                <i class="fas fa-shopping-cart text-white text-2xl"></i>  
            </div>  
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Métadonnées Odoo - Sale Orders</h1>  
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">  
                Analyse des commandes de vente synchronisées depuis Odoo via Kafka  
            </p>  
        </div>  
  
        <!-- Stats Cards -->  
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">  
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">  
                <div class="flex items-center">  
                    <i class="fas fa-database text-purple-500 text-3xl mr-4"></i>  
                    <div>  
                        <h3 class="text-sm text-gray-600">Total Jobs Odoo</h3>  
                        <p class="text-2xl font-bold text-gray-800">{{ enriched_jobs|length }}</p>  
                    </div>  
                </div>  
            </div>  
              
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">  
                <div class="flex items-center">  
                    <i class="fas fa-check-circle text-green-500 text-3xl mr-4"></i>  
                    <div>  
                        <h3 class="text-sm text-gray-600">Source</h3>  
                        <p class="text-lg font-bold text-gray-800">Kafka Odoo VRP</p>  
                    </div>  
                </div>  
            </div>  
              
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">  
                <div class="flex items-center">  
                    <i class="fas fa-shield-alt text-blue-500 text-3xl mr-4"></i>  
                    <div>  
                        <h3 class="text-sm text-gray-600">Gouvernance</h3>  
                        <p class="text-lg font-bold text-gray-800">Active</p>  
                    </div>  
                </div>  
            </div>  
        </div>  
  
        <!-- Jobs List -->  
        {% for item in enriched_jobs %}  
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">  
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">  
                <div class="flex justify-between items-center">  
                    <h2 class="text-2xl font-bold text-white flex items-center">  
                        <i class="fas fa-file-invoice mr-3"></i>  
                        {{ item.job.original_filename }}  
                    </h2>  
                    <div class="flex items-center space-x-4">  
                        <span class="bg-white text-purple-600 px-3 py-1 rounded-full text-sm font-semibold">  
                            {{ item.record_count }} records  
                        </span>  
                        <span class="bg-white text-purple-600 px-3 py-1 rounded-full text-sm font-semibold">  
                            {{ item.job.upload_date|date:"d/m/Y H:i" }}  
                        </span>  
                    </div>  
                </div>  
            </div>  
              
            <div class="overflow-x-auto">  
                <table class="min-w-full divide-y divide-gray-200">  
                    <thead class="bg-gray-50">  
                        <tr>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Colonne</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Types d'Entités</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Échantillons</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Détections</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Catégorie RGPD</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sensibilité</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Politique Ranger</th>  
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>  
                        </tr>  
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">  
                        {% for column in item.metadata %}  
                        <tr class="hover:bg-gray-50">  
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">  
                                {{ column.column_name }}  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap">  
                                {% for entity_type in column.entity_types %}  
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-1 mb-1">  
                                    {{ entity_type }}  
                                </span>  
                                {% endfor %}  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">  
                                {% for sample in column.sample_values %}  
                                <div class="text-xs text-gray-600">{{ sample|truncatechars:20 }}</div>  
                                {% endfor %}  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">  
                                {{ column.total_entities }}  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap text-sm">  
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">  
                                    {{ column.recommended_rgpd_category }}  
                                </span>  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap text-sm">  
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">  
                                    {{ column.recommended_sensitivity_level }}  
                                </span>  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap text-sm">  
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">  
                                    {{ column.recommended_ranger_policy }}  
                                </span>  
                            </td>  
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">  
                                <button onclick="openColumnValidationModal('{{ item.job_id }}', '{{ column.column_name|escapejs }}', {{ column.entity_types|safe }})"   
                                        class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">  
                                    <i class="fas fa-check mr-1"></i>  
                                    Valider  
                                </button>  
                            </td>  
                        </tr>  
                        {% endfor %}  
                    </tbody>  
                </table>  
            </div>  
        </div>  
        {% empty %}  
        <div class="bg-white rounded-xl shadow-lg p-12 text-center">  
            <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>  
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Aucun batch Odoo</h3>  
            <p class="text-gray-500">Les données Odoo apparaîtront ici par batch</p>  
        </div>  
        {% endfor %}
    </div>  
  
    <!-- Modal de Validation -->  
    <div id="columnValidationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">  
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">  
            <div class="flex justify-between items-center mb-4">  
                <h3 class="text-2xl font-bold text-gray-900">Validation de Colonne</h3>  
                <button onclick="closeColumnValidationModal()" class="text-gray-400 hover:text-gray-600">  
                    <i class="fas fa-times text-2xl"></i>  
                </button>  
            </div>  
              
            <form id="columnValidationForm" class="space-y-4">  
                <input type="hidden" id="modalJobId" name="job_id">  
                <input type="hidden" id="modalColumnName" name="column_name">  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type d'Entité</label>  
                    <select id="columnEntityType" name="entity_type" class="w-full px-3 py-2 border border-gray-300 rounded-md">  
                        <option value="PERSON">PERSON</option>  
                        <option value="EMAIL_ADDRESS">EMAIL_ADDRESS</option>  
                        <option value="PHONE_NUMBER">PHONE_NUMBER</option>  
                        <option value="LOCATION">LOCATION</option>  
                        <option value="ORGANIZATION">ORGANIZATION</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Statut de Validation</label>  
                    <select id="columnValidationStatus" name="validation_status" class="w-full px-3 py-2 border border-gray-300 rounded-md">  
                        <option value="validated">✅ Validé</option>  
                        <option value="rejected">❌ Rejeté</option>  
                        <option value="pending">⏳ En attente</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie RGPD</label>  
                    <select id="columnRgpdCategory" name="rgpd_category" class="w-full px-3 py-2 border border-gray-300 rounded-md">  
                        <option value="Données d'identification">Données d'identification</option>  
                        <option value="Données de contact">Données de contact</option>  
                        <option value="Données de localisation">Données de localisation</option>  
                        <option value="Données financières">Données financières</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Niveau de Sensibilité</label>  
                    <select id="columnSensitivityLevel" name="sensitivity_level" class="w-full px-3 py-2 border border-gray-300 rounded-md">  
                        <option value="PERSONAL_DATA">PERSONAL_DATA</option>  
                        <option value="SENSITIVE_DATA">SENSITIVE_DATA</option>  
                        <option value="INTERNAL">INTERNAL</option>  
                        <option value="PUBLIC">PUBLIC</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Politique Ranger</label>  
                    <select id="columnAnonymizationMethod" name="anonymization_method" class="w-full px-3 py-2 border border-gray-300 rounded-md">  
                        <option value="ranger_masking_policy_person">Masquage Complet</option>  
                        <option value="ranger_partial_masking_policy_phone">Masquage Partiel</option>  
                        <option value="ranger_hashing_policy_id">Hachage</option>  
                    </select>  
                </div>  
                  
                <div>  
                    <label class="block text-sm font-medium text-gray-700 mb-2">Commentaires</label>  
                    <textarea id="columnAnnotationComments" name="annotation_comments" rows="3"   
                              class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>  
                </div>  
                  
                <div class="flex justify-end space-x-3 pt-4">  
                    <button type="button" onclick="closeColumnValidationModal()"   
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">  
                        Annuler  
                    </button>  
                    <button type="button" onclick="saveColumnAnnotation()"   
                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">  
                        <i class="fas fa-save mr-2"></i>Sauvegarder  
                    </button>  
                </div>  
            </form>  
        </div>  
    </div>  
  
    <script>
        // CORRECTION CRITIQUE: Obtenir le CSRF token correctement
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        function openColumnValidationModal(jobId, columnName, entityTypes) {  
            document.getElementById('modalJobId').value = jobId;  
            document.getElementById('modalColumnName').value = columnName;  
              
            if (entityTypes && entityTypes.length > 0) {  
                document.getElementById('columnEntityType').value = entityTypes[0];  
            }  
              
            document.getElementById('columnValidationModal').classList.remove('hidden');  
        }  
          
        function closeColumnValidationModal() {  
            document.getElementById('columnValidationModal').classList.add('hidden');  
        }  
          
        function saveColumnAnnotation() {  
            const jobId = document.getElementById('modalJobId').value;  
            const columnName = document.getElementById('modalColumnName').value;  
              
            const data = {  
                entity_type: document.getElementById('columnEntityType').value,  
                validation_status: document.getElementById('columnValidationStatus').value,  
                rgpd_category: document.getElementById('columnRgpdCategory').value,  
                sensitivity_level: document.getElementById('columnSensitivityLevel').value,  
                anonymization_method: document.getElementById('columnAnonymizationMethod').value,  
                annotation_comments: document.getElementById('columnAnnotationComments').value  
            };  
              
            fetch(`/recommendations/column-validation/${jobId}/${columnName}/`, {  
                method: 'POST',  
                headers: {  
                    'Content-Type': 'application/json',  
                    'X-CSRFToken': csrftoken
                },  
                body: JSON.stringify(data)  
            })  
            .then(response => response.json())  
            .then(result => {  
                if (result.success) {  
                    showToast('✅ Validation sauvegardée avec succès', 'success');  
                    closeColumnValidationModal();  
                    setTimeout(() => location.reload(), 1500);  
                } else {  
                    showToast('❌ Erreur: ' + result.error, 'error');  
                }  
            })  
            .catch(error => {  
                showToast('❌ Erreur réseau', 'error');  
                console.error('Error:', error);  
            });  
        }  
          
        function showToast(message, type) {  
            const toast = document.createElement('div');  
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} z-50`;  
            toast.textContent = message;  
            document.body.appendChild(toast);  
            setTimeout(() => toast.remove(), 3000);  
        }  
    </script>  
</body>  
</html>